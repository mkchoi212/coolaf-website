<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Common Gotchas in Go - 0xDEADBEEF</title>
    <meta name="description" content="First thing is first. Happy New Years üéâüéâ">

    <link href='https://fonts.googleapis.com/css?family=Roboto+Mono|Roboto:300,400,900,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://www.deadbeef.me/2018/01/go-gotchas">
    <link rel="alternate" type="application/rss+xml" title="0xDEADBEEF" href="https://www.deadbeef.me/feed.xml">
    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Common Gotchas in Go | 0xDEADBEEF</title>
<meta name="generator" content="Jekyll v3.4.3" />
<meta property="og:title" content="Common Gotchas in Go" />
<meta name="author" content="Mike JS. Choi" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="whooooops" />
<meta property="og:description" content="whooooops" />
<link rel="canonical" href="https://www.deadbeef.me/2018/01/go-gotchas" />
<meta property="og:url" content="https://www.deadbeef.me/2018/01/go-gotchas" />
<meta property="og:site_name" content="0xDEADBEEF" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-01-01T00:55:03-06:00" />
<script type="application/ld+json">
{"description":"whooooops","author":{"@type":"Person","name":"Mike JS. Choi"},"@type":"BlogPosting","url":"https://www.deadbeef.me/2018/01/go-gotchas","headline":"Common Gotchas in Go","dateModified":"2018-01-01T00:55:03-06:00","datePublished":"2018-01-01T00:55:03-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.deadbeef.me/2018/01/go-gotchas"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

    <body>
        <main class="u-container">
        <div class="c-page">
    <header class="c-page__header">
    <h1><code>0xDEADBEEF</code></h1>

    
    <p>
        <a href="/">Home</a><span
          class="u-separate"></span> <a href="/projects/">Projects</a><span class="u-separate"></span> <a href="/about/">About</a><span class="u-separate"></span><a href="/feed.xml">RSS</a>
    </p>
</header>

    <div class="c-page__main">
    <article class="c-article">
    <header class="c-article__header">
        <h1 class="c-article__title">Common Gotchas in Go</h1>
        <p class="c-article__time"><time datetime="2018-01-01T00:55:03-06:00" itemprop="datePublished">Jan 1, 2018</time></p>
    </header>
    
    <!-- Post Tags -->
    <ul class="c-tags">
    
      <li class="c-tag">go</li>
    
    </ul>

    <div class="c-article__main">
        <p>First thing is first. Happy New Years üéâüéâ</p>

<p>Now that‚Äôs out of the way, let‚Äôs talk about Go. I recently finished making my first real Go program. It‚Äôs called ‚ÄúFix All Conflicts‚Äù or <a href="https://github.com/mkchoi212/fac">fac</a> for short. It‚Äôs an easy-to-use console user interface for fixing git merge conflicts. I made it because I never found a merge tool that was intuitive enough to use.</p>

<p>The process was quite fun and I learned a lot about Go in the process. So, to wrap up my first official foray into Rob Pike‚Äôs mystical land of gophers, I decided to write down some of the common ‚ÄúGotchas!‚Äù that any beginning Gopher - me - can run into.</p>

<p class="center"><img src="http://www.confusedcoders.com/wp-content/uploads/2016/10/golang-1.jpg" alt="" /></p>
<blockquote>
  <p>Gophers can be quite aggressive sometimes.</p>
</blockquote>

<h1 id="Ô∏è-1-range">‚ö†Ô∏è 1.) Range</h1>

<p>The <code class="highlighter-rouge">range</code> function is one of the most commonly used functions in Go. Here‚Äôs a sample use case of the <code class="highlighter-rouge">range</code> function. Note that for some demented reason, we decided to make all the animals in the zoo have <code class="highlighter-rouge">999</code> legs.</p>
<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="s">"fmt"</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">Animal</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">name</span><span class="x"> </span><span class="kt">string</span><span class="x">
	</span><span class="n">legs</span><span class="x"> </span><span class="kt">int</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">zoo</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="n">Animal</span><span class="p">{</span><span class="x">
		</span><span class="n">Animal</span><span class="p">{</span><span class="s">"Dog"</span><span class="p">,</span><span class="x"> </span><span class="m">4</span><span class="p">},</span><span class="x">
		</span><span class="n">Animal</span><span class="p">{</span><span class="s">"Chicken"</span><span class="p">,</span><span class="x"> </span><span class="m">2</span><span class="p">},</span><span class="x">
		</span><span class="n">Animal</span><span class="p">{</span><span class="s">"Snail"</span><span class="p">,</span><span class="x"> </span><span class="m">0</span><span class="p">},</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"-&gt; Before update %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">zoo</span><span class="p">)</span><span class="x">

	</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">animal</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">zoo</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="c">// üö® Oppps! `animal` is a copy of an element üòß</span><span class="x">
		</span><span class="n">animal</span><span class="o">.</span><span class="n">legs</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">999</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">-&gt; After update %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">zoo</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>
<p>The above code looks innocent enough. However, you may be surprised to find that <code class="highlighter-rouge">animals.legs = 999</code> didn‚Äôt do anything.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>-&gt; Before update [{Dog 4} {Chicken 2} {Snail 0}]
-&gt; After update  [{Dog 4} {Chicken 2} {Snail 0}] üö®üö®üö® 
</code></pre>
</div>

<h3 id="lesson">Lesson</h3>

<blockquote>
  <p>Value property of <code class="highlighter-rouge">range</code> (stored here as <code class="highlighter-rouge">animal</code>) is a <strong>copy of the value from <code class="highlighter-rouge">zoo</code>, not a pointer to the value in <code class="highlighter-rouge">zoo</code>.</strong></p>
</blockquote>

<h3 id="the-fix">The Fix</h3>

<p>In order to modify an element within the array, we must change the element via its <strong>pointer</strong>.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">for</span><span class="x"> </span><span class="n">idx</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">zoo</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="n">zoo</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">legs</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">999</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>
<p>This may look quite trivial but you may be surprised to find this as a one of the most common source of bugs; at least for me!</p>

<p><a href="https://play.golang.org/p/jhL_MNbXnPC">¬ª Go playground #1 for you to play around in</a></p>

<h1 id="Ô∏è-2-the--thingy">‚ö†Ô∏è 2.) The ‚Ä¶ thingy</h1>

<p>You may have used the <code class="highlighter-rouge">‚Ä¶</code> keyword in the C programming language to create a <a href="https://www.gnu.org/software/libc/manual/html_node/Variadic-Functions.html">variadic function</a>; variadic function is a function that takes a variable number or type of arguments.</p>

<p>In C, you have to successively call the <code class="highlighter-rouge">va_arg</code> macro in order to access the optional arguments. And if you use the variadic argument in any other way, the compiler will throw an error.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">add_em_up</span> <span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">,...)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">va_start</span> <span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>         <span class="cm">/* Initialize the argument list */</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">sum</span> <span class="o">+=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>   <span class="cm">/* Get the next argument value */</span>
  <span class="n">va_end</span> <span class="p">(</span><span class="n">ap</span><span class="p">);</span>                  <span class="cm">/* Clean up */</span>
  <span class="k">return</span> <span class="n">sum</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In Go however, things are similar but quite different at the same time. Here is a variadic function <code class="highlighter-rouge">myFprint</code> in Go. Notice how the variadic argument <code class="highlighter-rouge">a</code> is being used.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">myFprint</span><span class="p">(</span><span class="n">format</span><span class="x"> </span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="n">a</span><span class="x"> </span><span class="o">...</span><span class="k">interface</span><span class="p">{})</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="m">0</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="n">format</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="c">// ‚ö†Ô∏è `a` should be `a...`</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="x"> </span><span class="n">a</span><span class="p">)</span><span class="x">
		</span><span class="c">// ‚úÖ</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="x"> </span><span class="n">a</span><span class="o">...</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">myFprint</span><span class="p">(</span><span class="s">"%s : line %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="s">"file.txt"</span><span class="p">,</span><span class="x"> </span><span class="m">49</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>[file.txt %!s(int=49)] : line %!d(MISSING)
file.txt : line 49
</code></pre>
</div>

<p>You‚Äôd think that the compiler would throw an error here for using the variadic parameter <code class="highlighter-rouge">a</code> in a wrong way. But notice how <code class="highlighter-rouge">fmt.Sprintf</code> just used the first argument in <code class="highlighter-rouge">a </code> without throwing a fit.</p>

<h3 id="lesson-1">Lesson</h3>

<blockquote>
  <p>In Go, <strong>variadic parameters are converted to slices by the compiler</strong></p>
</blockquote>

<p>This means that the variadic argument <code class="highlighter-rouge">a</code> is in fact, just a slice. Because of this, the code below is completely valid.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="c">// `a` is just a slice!</span><span class="x">
</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">elem</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">a</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h3 id="the-fix-1">The Fix</h3>

<blockquote>
  <p><strong>Remember to type ALL THREE DOTS whenever using variadic parameters!</strong></p>
</blockquote>

<p><a href="https://play.golang.org/p/303g8_1IVFD">¬ª Go playground #2 for you to play around in</a></p>

<h1 id="Ô∏è-3-slicing">‚ö†Ô∏è 3.) Slicing</h1>
<p>If you have done your fair share of slicing in Python, you may remember that slicing in Python gives you a new list with just the references to the elements copied over. This property allows for code like this in Python.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>			<span class="c"># üëÄ a completely new list!</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">999</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span>
<span class="p">[</span><span class="mi">999</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</code></pre>
</div>

<p>However if you try the same thing in Go, you get something else.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">data</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">1</span><span class="p">,</span><span class="x"> </span><span class="m">2</span><span class="p">,</span><span class="x"> </span><span class="m">3</span><span class="p">}</span><span class="x">
	</span><span class="n">slice</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">data</span><span class="p">[</span><span class="o">:</span><span class="m">2</span><span class="p">]</span><span class="x">
	</span><span class="n">slice</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">999</span><span class="x">

	</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="x">
	</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">slice</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>[999 2 3]
[999 2]
</code></pre>
</div>

<h3 id="lesson-2">Lesson</h3>

<blockquote>
  <p>In Go, <strong>a slice shares the same backing array and capacity as the original.</strong> So if you change an element in the slice, the original contents are modified as well.</p>
</blockquote>

<h4 id="the-fix-2">The Fix</h4>

<p>If you want to get an independent slice, you have two options.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="c">// Option #1</span><span class="x">
</span><span class="c">// appending elements to a nil slice</span><span class="x">
</span><span class="c">// `...` changes slice to arguments for the variadic function `append`</span><span class="x">
</span><span class="n">a</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="nb">append</span><span class="p">([]</span><span class="kt">int</span><span class="p">{},</span><span class="x"> </span><span class="n">data</span><span class="p">[</span><span class="o">:</span><span class="m">2</span><span class="p">]</span><span class="o">...</span><span class="p">)</span><span class="x">

</span><span class="c">// Option #1</span><span class="x">
</span><span class="c">// Create slice with length of 2</span><span class="x">
</span><span class="c">// copy(dest, src)</span><span class="x">
</span><span class="n">a</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="x"> </span><span class="m">2</span><span class="p">)</span><span class="x">
</span><span class="nb">copy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="x"> </span><span class="n">data</span><span class="p">[</span><span class="o">:</span><span class="m">2</span><span class="p">])</span><span class="x">
</span></code></pre>
</div>

<p>And according to <a href="https://stackoverflow.com/a/44337887/4064189">StackOverflow</a>, the <code class="highlighter-rouge">append</code> option is slightly faster than the <code class="highlighter-rouge">make. + copy</code> option!</p>

<p><a href="https://play.golang.org/p/HvVFmQZTcjp">¬ª Go playground #3 for you to play around in</a></p>

<p><a href="https://news.ycombinator.com/item?id=16048206">Hacker News thread ü§©</a></p>

    </div>
  
    <!-- Previous / Next Buttons -->
    
    

    
    

    <div class="pagenav">
		
        <div class="wrapper" id="left">
          <small><b>Previous</b> Dec 23, 2017</small>
          <br>
            <a class="no-hov" href="/2017/12/learn-from-microsoft">&laquo; Things we can learn from Microsoft</a>
        </div>
		
		
        <div class="wrapper" id="right">
          <small>May 27, 2018 <b>Next</b></small>
          <br>
          <a class="no-hov" href="/2018/05/go-test">Go test your tests in Go with go test &raquo;</a>
        </div>
		
		</div>

		<!-- Disqus comments view -->
		
		<div class="post-disqus">
				<section id="disqus_thread"></section>
				<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */

var disqus_config = function () {
  this.page.url = 'https://www.deadbeef.me/2018/01/go-gotchas';  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = '/2018/01/go-gotchas'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://deadbeef-me.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

		</div>
		
</article>

    </div>
    <footer class="c-page__footer">
    <p>&copy; Mike JS. Choi 2018</p>
    <p><a href="https://twitter.com/bananamlkshake2">Twitter</a><span class="u-separate"></span><a href="https://github.com/mkchoi212">Github</a></p>
</footer>

</div>

        </main>
    
    </body>
</html>
